<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SAR Global Viewer</title>
  <style>
    html,body{margin:0;background:#111;color:#ddd;font-family:system-ui,Segoe UI,Arial}
    #wrap{display:flex;gap:16px;padding:12px;align-items:flex-start}
    #info{min-width:240px}
    canvas{image-rendering: pixelated; background:#000}
    h1{font-size:18px;margin:0 0 8px}
    .row{margin:6px 0}
    code{background:#222;padding:2px 4px;border-radius:4px}
  </style>
</head>
<body>
<div id="wrap">
  <div id="info">
    <h1>Global View</h1>
    <div class="row">WS: <code id="wsurl"></code></div>
    <div class="row">Timer: <span id="timer">0</span> s</div>
    <div class="row">Player: <span id="p"></span></div>
    <div class="row">Victims: <span id="vcount">0</span></div>
    <div class="row">Walls: <span id="wcount">0</span></div>
    <div class="row">Tip: open this page on any computer in your LAN.</div>
  </div>
  <canvas id="c"></canvas>
</div>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const wsurlEl = document.getElementById('wsurl');
  const timerEl = document.getElementById('timer');
  const pEl = document.getElementById('p');
  const vcountEl = document.getElementById('vcount');
  const wcountEl = document.getElementById('wcount');

  let CELL=20, W=60, H=40;
  let state = {
    walls: new Set(),
    victims: {},  // {"x,y":"red|purple|yellow"}
    player: [0,0],
    time_remaining: 0
  };

  function resize() {
    canvas.width = W * CELL;
    canvas.height = H * CELL;
  }

  function grid() {
    ctx.strokeStyle = '#1f1f1f';
    ctx.lineWidth = 1;
    for (let x=1; x<W; x++){
      ctx.beginPath(); ctx.moveTo(x*CELL, 0); ctx.lineTo(x*CELL, H*CELL); ctx.stroke();
    }
    for (let y=1; y<H; y++){
      ctx.beginPath(); ctx.moveTo(0, y*CELL); ctx.lineTo(W*CELL, y*CELL); ctx.stroke();
    }
  }

  function drawWalls() {
    ctx.fillStyle = '#444';
    for (const key of state.walls) {
      const [x,y] = key.split(',').map(Number);
      ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
    }
  }

  function drawVictims() {
    for (const [key, kind] of Object.entries(state.victims)) {
      const [x,y] = key.split(',').map(Number);
      ctx.beginPath();
      const cx = x*CELL + CELL/2, cy = y*CELL + CELL/2;
      ctx.arc(cx, cy, Math.max(3, CELL*0.35), 0, Math.PI*2);
      // simple colors; adjust if you use different scheme
      ctx.fillStyle = (kind === 'red') ? '#e74c3c'
                  :  (kind === 'purple') ? '#8e44ad'
                  :  (kind === 'yellow') ? '#f1c40f'
                  : '#2ecc71';
      ctx.fill();
    }
  }

  function drawPlayer() {
    const [x,y] = state.player;
    ctx.fillStyle = '#00aaff';
    ctx.fillRect(x*CELL+CELL*0.15, y*CELL+CELL*0.15, CELL*0.7, CELL*0.7);
  }

  function render() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    grid();
    drawWalls();
    drawVictims();
    drawPlayer();
    requestAnimationFrame(render);
  }
  render();

  // Connect to host WebSocket (same host, port 8765)
  const WS_URL = `ws://${location.hostname}:8765`;
  wsurlEl.textContent = WS_URL;

  function applySnapshot(d) {
    W = d.PLAY_W; H = d.PLAY_H; CELL = d.CELL_SIZE; resize();
    state.walls = new Set(d.walls.map(p => `${p[0]},${p[1]}`));
    state.victims = d.victims || {};
    state.player = d.player || [0,0];
    state.time_remaining = d.time_remaining || 0;
    updateHud();
  }

  function applyUpdate(d) {
    state.player = d.player || state.player;
    state.time_remaining = d.time_remaining ?? state.time_remaining;
    state.victims = d.victims || state.victims;
    updateHud();
  }

  function updateHud(){
    timerEl.textContent = Math.max(0, Math.round(state.time_remaining));
    pEl.textContent = `${state.player[0]}, ${state.player[1]}`;
    vcountEl.textContent = Object.keys(state.victims).length;
    wcountEl.textContent = state.walls.size;
  }

  function connect() {
    const ws = new WebSocket(WS_URL);
    ws.onmessage = ev => {
      const data = JSON.parse(ev.data);
      if (data.type === 'snapshot') applySnapshot(data);
      else if (data.type === 'update') applyUpdate(data);
    };
    ws.onclose = () => setTimeout(connect, 1000); // auto-retry
    ws.onerror = () => { try { ws.close(); } catch (_) {} };
  }
  connect();
})();
</script>
</body>
</html>
